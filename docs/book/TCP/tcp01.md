# TCP概述

## 什么是TCP/IP？
> TCP/IP协议并不指代任何具体的一种或几种协议，而是泛指涉及到网络层和传输层的协议族。而因为这个协议族中IP协议和TCP协议使用量最大，占据了流量中的绝大部分，因此统称为TCP/IP协议。

Tcp/IP泛指OSI7层网络模型中的，三层和四层网络协议。下面是常用的三种网络模型示意图，三层几乎指代的都是IP层，而四层指代的都是传输层(或者说运输层，本科教材中说传输层的比较多，也有一些资料翻译成运输层)

![](https://yx-prod-resources-shared-1254112465.cos.ap-beijing.myqcloud.com/1/1012d13c9a71e4c99619322866dec92d-158947)

### TCP概述

TCP属于有状态的链接协议(相对于有状态链接，UDP则是无状态协议)，首先需要明确什么是状态？

网络链接状态，指的是客户端和服务端同时维护链接数据，包括但不限于：
1. 链接源IP
2. 源端口
3. 目标IP
4. 目标端口
5. 当前链接状态(正在建立连接、已经建立连接、正在传输数据、正在断开、已经断开等)
6. 链接参数(MSL、MSS、RTO、RTT等)
7. 当前传输数据的状态(ACK、SEQ、WINDOW等)

![](https://yx-prod-resources-shared-1254112465.cos.ap-beijing.myqcloud.com/1/135157ea7123ac373d2d12b408f7a59d-119000)

TCP协议复杂就在于客户端和服务端需要时刻为了保持链接，而进行的参数动态调整。 例如：链接管理中的三次握手是为了确认双方都明确完成网络初始化，四次挥手同样是为了确认双方都已经销毁了网络资源。  在握手阶段，双方相互交换彼此参数(初始序列号、最大段大小、窗口大小等参数)，双方都根据对方数据协商一致后使用这些参数封装协议数据报。同样双方为了最大程度保持链接稳定性，当发现数据报出现超时、丢包时会按照协商好的步骤进行超时重传或者执行拥塞控制。而在执行超时重传或者拥塞控制时，为了尽可能的利用网络资源就衍生出了很多的算法。

TCP费劲心思的维护状态，最核心的目标在于保证数据完整性，确保服务端(是的，只确保服务端)都接受到了预期的数据。

在学习TCP/IP协议时，会经常出现帧、数据包和数据报这些名称。以下是其区别，数据报是四层使用的数据(Segment TCP/Datagram UDP),数据包是三层使用的数据(Packet),而帧是二层传输的数据(Frame)。

![](https://yx-prod-resources-shared-1254112465.cos.ap-beijing.myqcloud.com/1/79f03ae4f8c6cdb7bbb1400a29d700be-61983)

### TCP协议总结

TCP协议目标是可靠稳定传输数据，因此其所有衍生出来的算法都是为了达到这个目标而存在。

为了传输稳定，在创建链接时需要客户端和服务端都保存链接参数，而后根据这些参数发送数据。为了可靠，则需要重点解决两个问题：超时和拥塞。

+ 超时

为了识别出超时，则需要为每一个数据报设置一个定时器，在规定的时间内没有收到服务端的确认信息(ACK)。则表示这个数据报在传输过程中丢失了，客户端就需要重传这个数据报。
原理很简单，但在实际情况中需要考虑以下几个问题：
1. 性能。 如果为每个数据报都设置定时器，则会严重影响性能(定时器是Linux内核设置还是网卡硬件设置？但如果为每个数据报都设置性能都是问题)。
2. 伪超时。服务端的ACK可能会发生乱序，导致客户端先收到后面的ACK，而误认为前面的数据报发生了丢包。
3. 重复。数据报在中间传输过程中，可能因为某些原因导致发生了重复，客户端接收到重复的ACK可能会误判需要快速重传。
4. 合适的超时时间。如何根据当前网络状况设置一个合适的超时时间

从上面四个原因来看，最根本的原因在于客户端和服务端相互无法”面对面”沟通。 服务端到底有没有收到数据，客户端是不知道的，只能依赖于ACK来确认。 而ACK恰恰也是通过网络传输的，因此ACK也有可能出现各种“意外”情况，为了尽可能的使客户端了解到服务端“真实”的想法，各路大牛就想出了很多优化算法来接近事实真相。

+ 拥塞

拥塞时必然出现超时，但超时未毕拥塞。所以超时是判断拥塞的一个指标。


TCP判断拥塞，主要依靠:
1. RTT。 双向通讯时长，为了真实获取每个数据报在网络上面的传输时间。客户端发送数据报时会携带发送时间戳，当收到ACK时使用当时的时间-报文中的时间戳就可以计算出传输时间(双向需要减半)。
2. 发送窗口。客户端通过判断服务端返回的接受窗口大小来判断，服务端是否发生或者即将发生拥塞。如果判断需要拥塞控制，则根据算法调整后续发送。
3. 超时。
4. 丢包率。当每次发生超时重传时，其实就意味着发生了丢包事件。但丢包还有其他原因，例如传输错误(WIFI场景中)或者校验和计算错误等等。所以仍然不能将丢包和超时等同起来，需要单独将丢包率作为判断拥塞的一个参考指标。

而判断是否发生拥塞，最不需要判断的就是发送速率。拥塞和发送速率没有必然关系。 可能因为发送速率太快导致网络无法承受而发生拥塞。也有可能发送速率不高，但因为中间环节(路由器)出现问题导致超时或者丢包引起中间拥塞。所以不需要将发送速率作为拥塞判断标准。

其次还有一种拥塞表现形式，就是本地拥塞。这种情况不太经常出现，基本都是本地缓冲区出现溢出时才会出现。

![](https://yx-prod-resources-shared-1254112465.cos.ap-beijing.myqcloud.com/1/a884dd571482045aa6ceb86739ccf0fb-171522)