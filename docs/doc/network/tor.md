# 浅谈翻墙和暗网的一些区别

> Tor 和翻墙属于两种不同体系的网络工具，其用途和场景有一些重叠的地方，但绝大部分场景是不同的

## 翻墙工具和其工具集

首先来说翻墙工具是用于翻越 GFW 的，所以其一切出发点都基于骗过 GFW 的流量审查，使其不能准确探知真实流量意图。

一般来说，其网络拓扑大致如下:

![](https://p.ipic.vip/lf62s2.png)

用户在`GFW`的左侧也就是本地使用某种翻墙协议，访问`GFW`的右侧网站。 右侧的`remote server`是不是必须的？ 不一定是必须的，如果左侧使用的协议足够强大，并且可以成功迷惑`GFW`，那么就不需要右侧的`remote server`。但很遗憾，目前还没有发现有这个足够强大的协议。 因此需要右侧添加一个`server`作为流量接应。

下面以翻墙届最著名的`shadowsocks`协议为例来简单讲解翻墙的步骤。

![](https://p.ipic.vip/yijo9i.png)

`shadowsocks`是典型的 CS 架构，分为`client`和`server` 两个服务。 在左侧(也就是用户侧)需要安装`shadowsocks client` ，它的作用是将用户访问的流量进行混淆加密，然后传递给右侧的`shadowsocks server` 。

混淆加密所使用的加密方式和密钥，由`server` 端来确定。

当`server` 端接受到加密后的流量以后，会使用事先协商的加解密参数，进行解密。 当解密成功后，就可以获取到用户侧真实的访问意图了。 此时再代替用户去访问对方网站，一旦访问成功，`server`再将流量加密原样返回给`client`。

从上图可以得知，最影响用户体验的是从本地网络到`remote server`这一段的网络质量，所以有人做了一些改进如下:

![](https://p.ipic.vip/a7o90u.png)

通过引入一个中继节点`bridge server`实现`GFW`两侧的高速网络连接。

由此可见，`client`和`server` 并没有严格的分工。 两者的区别仅仅在于`client`除了访问`server`之外，不会主动访问其他进程。 而`server`只接受来自`client`的请求，不接受其他流量请求。

为了安全性，双方协商的加密方式和密钥并不会进行实时交互，而是通过另外一条通道进行交互(邮件、网站或者其他方式)。 这样设计的本意在于防止第三方(GFW)截获密钥传输。 但其实上，这样做反而更容易暴露自己。

因为在密码学中最重要的一条准则是，必须要将自己伪装成普通人。 虽然 GFW 无法截获密钥，但 GFW 可以反向推断，如果有非常规律的访问某个`remote server`，并且流量并不属于任何已知流量(HTTP/HTTPS/Websocket 等等已知的公开协议)，那么就属于可疑流量，直接 Refused。

虽然`shadowsocks`在设计上有种种漏洞，但不可否认`shadowsocks`为翻墙贡献了很多有益的思路，直接影响了后续翻墙方案的实现，比如目前使用范围最广的`v2ray`方案。

在吸取了`shadowsocks`流量非常容易识别的弊端后，`v2ray`更加注意伪装。 首先`v2ray`优先将自己伪装成`https`流量(目前表网最大的加密流量)，其次`v2ray server`会推荐通过 lvs 进行流量分流。如果请求无法正确解密，那么自动返回一个 web 内容。 这样就可以规避掉来自`GFW`的嗅探请求。

所以`v2ray`的典型拓扑是这样的:

![](https://p.ipic.vip/qkxwk7.png)

V2ray 在伪装方面比 shadowsocks 要强一些，它的理念是"大隐隐于市"。隐藏一个普通人最好的方式就是将它放到人群中。

在隐藏方面`v2ray`并不是最优秀的，目前公开领域伪装做的最好的是`Tor`,也就是传说中的`暗网`

# Tor 和暗网

暗网指的是在因特网上不被人知的网站或者资源。 普通用户访问或者检索网络资源时，大多数都会选择使用搜索引擎，可以被搜索引擎收录并反馈给用户的网络资源称之为`表网`。 那些无法被收录的网络资源，就被称为`暗网`。

除去搜索引擎因素之外，还有一些网站是`主动`不希望被人所发现和拦截的，这些也称之为`暗网`。 综上所述，只要是普通人无法轻易接触的网络资源都可以统称为`暗网`。

下面主要描述的是第二类暗网资源，即主动的，不希望被第三方所拦截的网络资源。

在访问这一类资源时，就不能使用常用的表网方式(搜索引擎+http(s)协议)。 因为这些方式非常容易被拦截和分析，从而泄露个人隐私。 访问暗网经常使用的是`Tor网络`，也称之为洋葱网络。 常见的 Tor 拓扑如下:

![](https://p.ipic.vip/ht6fal.png)

用户发起一个请求时，会依次经过三个`中继节点`，最后一个节点会代替用户访问目标网站，并负责将网站响应依次返回给用户。

每一个数据包从结构上来分析有四层，依次是：

- layer1 中继节点 1 可以解密的数据
- layer2 中继节点 2 可以解密的数据
- layer3 中继节点 3 可以解密的数据
- message 用户和目标网站之间传输的数据
  用图表示如下：

![](https://p.ipic.vip/ya9un5.png)

每个`中继节点`只负责解析当前节点数据，不负责解析(也无力解析)其他层的数据。 真实的数据(message)被一层一层的包裹起来，在传递的过程中，再一层一层的剥开，类似于洋葱一样。因此这样的网络模型就称之为`洋葱网络`。

从拓扑可以看出，用户如果需要接入到`Tor`网络。那么首先需要获取到中继节点的地址才可以，用户获取中继节点的方式如下:

![](https://p.ipic.vip/cf9a2c.png)

用户首先访问`Tor dictionary service`获取到当前所有中继节点的信息，然后根据打分原则选出对自己节点最友好的三个节点，并依次和这三个节点创建链路。这样一条暗网访问链路就创建完成了。

再创建链接时，用户首先和`bridge 1 `创建链接，`bridge 1`会创建一组对称密钥下发给用户。 然后用户再将`bridge 2`的信息发给`bridge 1`，让`bridge 1`和`bridge 2`创建链路。

`bridge 2`创建一组对称密钥，并将密钥信息发给`bridge 1`，`bridge 1`再将收到的信息用自己的密钥加密后发给用户。 这样用户只需要解开`bridge 1`的数据就可以拿到`bridge 2`的密钥。

同理， 用户让`bridge 1` 告诉`bridge 2`： 和`bridge 3`创建链路。 `bridge 3`创建密钥，并返回给`bridge 2`，`bridge 2`封装好以后返回给`bridge 1` 。 `bridge 1`最后返回给用户，用户依次使用`bridge 2`和`bridge 1`的密钥解密数据，就获取到了`bridge 3`的密钥。

此时用户已经有了三个中继节点的密钥，再往后用户需要发送数据的时候，就依次使用`bridge 3`、`bridge 2`和`bridge 1` 对 message 加密。

![](https://p.ipic.vip/erijzd.png)

这个模型并非完美无缺，有两个漏洞：

1. `bridge 3`如果被攻破，那么前面所有的加密将形同虚设
2. 如果三个`bridge`的网络流量被截获，即便不知道其内容，但也可以翻推出用户的网络位置

针对第一个漏洞而言，这并不是`tor`网络模式的问题。而是用户的 message 如果不是加密的，那么就一定会有这个问题。 所以`tor`建议用户访问目标网站时，一定要选择`SSL`加密。这样即便攻破`bridge 3`也无法破解 message。

第二个漏洞，`tor`是这样解决的。 `tor`为了避免网络挟持和反向跟踪，会不定时随机更换`bridge`节点。其实并不能完全避免反向跟踪，但已经大大增加了跟踪成本。

# 总结

根据上述介绍，相比应该知道翻墙侧重于突破`GFW`的网络审查和过滤，它的重点在于如何加密和混淆流量。网络流量方向是固定的，轻易不变更。因此翻墙服务更像是一个带有私有加解密协议的网络代理。

而暗网则侧重于网络反跟踪，重点在于不能轻易获取到用户个人隐私信息。所以它的网络模型属于强加密和随机路径，增大破解的难度和成本。

如果用户网络使用场景没有侧重，那么使用翻墙和暗网其实都可以。 如果有侧重点，那么还是需要根据实际情况选择合适的网络模型。
