# 浅入浅出 Kubernetes 流量分析

Kubernetes流量大致分为以下四种:

|方式|发起方|访问方式|
|---|-----|------|
|A|集群外|Ingress|
|B|集群外|3层路由|
|C|集群内|svc|
|D|集群内|3层路由|


本文首先从A(集群外通过Ingress访问集群服务)开始聊Kubernetes网络。

方式A的网络拓扑大致如下:

![k1.png](../../pic/doc/kubernetes/k8s-01.png)

为了简化模型，假设服务存在于Kubernetes其中一台节点上。外部流量经过LB(4层)后，被转发到Ingress节点(假设使用Nginx Ingress)中。

Ingrss节点收到流量请求之后，按照Http协议进行分析，解析出Host和Uri。 而后根据节点中内置的Iptables/Ipvs规则将流量转发到对应的目标节点之上。

目标节点接受到流量请求之后进行业务逻辑处理，而后将响应流量返回给来源节点。

来源节点接受到服务响应流量之后，同步返回给下游LB。 下游LB将流量返回给调用方。

下图是节点中转发流量的示意图:

![ipvs.png](../../pic/doc/kubernetes/ipvs.png)

在每个节点中都存在`kube-proxy`组件。这个组件用来为每个服务(Service)生成一个VIP(虚IP)，并且服务维护相对应的路由策略。

在集群网络中，存在`控制平面`和`数据平面`。 控制平面用来监控集群网络拓扑变化，并负责维护本节点的路由策略以满足拓扑变化。 数据平面则用来真实处理网络请求和响应流量。也就是说，`控制平台负责制定规则，而数据平面则用规则处理流量`。

具体到节点，集群中所有的`kube-proxy`就是控制平面。kube-proxy生成的`Iptables`规则或`Ipvs`规则就是数据平面。

在当前集群创建策略中，优先创建`Ipvs`规则，如果当前节点不满足`Ipvs`运行条件，则退化到`Iptables`规则中。

**Ipvs和Iptables的有哪些区别？**

+ 性能

在低流量情况下， Ipvs和Iptables性能几乎没有差异。当遇到高流量时，Ipvs凭借O(1)的查询算法复杂度会比使用O(n)的Iptables有更好的性能。同时Iptables会使用netconntrack跟踪每个建立成功的链接，所以当网络流量非常高的时候， net conntrack有可能会变成一个瓶颈。

+ 负载均衡

Iptables只有轮询这一种负载均衡算法(实际上，是计算一个随机数然后根据随机数决定路由到哪个Endpoint)。 Ipvs则支持轮替、最少链接、目标地址哈希、源地址哈希、最短预期延迟和从不排队这几种负载方式。



