# 一种可以加速访问github的设想及其实现
> 下面方案针对的是使用git命令(git clone / git pull /git push 等，不包含浏览器访问场景)时的加速方案。

在国内因为各种原因，访问github的速度一直不太稳定。 基于对国内政策的理解和尊重，本文尝试一种在合法合规基础之上的加速访问github的方式。

## 目前为什么访问github会很慢?

为了方便理解后面的方案描述，我们先来看当前为啥国内访问GitHub会很慢。 我们通过`dig`分别针对阿里云、腾讯云、百度三大运营商的dns解析`github.com`的域名，可以看到国内要么无法解析，要么大概率会解析出`20.205.243.166`这个IP。

![](https://tva1.sinaimg.cn/large/e6c9d24ely1h0gp8jjkbcj20u033fk4n.jpg)

通过查询IP归属地，可以发现`20.205.243.166`归属于新加坡数据中心。也就是说，国内访问github大概率需要(等同于必须)通过GFW。 而GFW的存在，会极大的提高访问延时，尤其在网络访问高峰期，几乎无法访问。 

访问路径大致是这样的:

![](https://tva1.sinaimg.cn/large/e6c9d24ely1h0gpdekwwxj215k0ck0uh.jpg)

如果想快速访问github，那么GFW就是绕不过去的坎。 所以很多人其实是这样操作的:

![](https://tva1.sinaimg.cn/large/e6c9d24ely1h0gpgbj23zj219e0d0gno.jpg)

这种就是江湖人称的"翻墙"。 代理服务器在访问流量不高的时候，不会引起GFW的注意，所以可能会快速通过，进而带来相对而言的高速访问。 但这种访问是钻了"政策"(关于VPN的管理规定)的漏洞，深究起来具有一些政策风险。 

好了，这种方法不可用。 那还有什么方式可以加速github的访问呢？

## 找到一条最佳的路由

既然翻墙是不合法的，那么我们就需要找到一条合法合规的方式。 从上面的分析可以知道，当前访问`github.com`速度慢是因为访问的是新加坡数据中心，如果不访问新加坡呢？ 比如说访问韩国，访问日本呢？

我们之所以会访问新加坡数据中心，是因为国内的DNS设置的IP是新加坡的`20.205.243.166`。如果我们可以解析出一个另外的IP，比如西雅图的IP，或者日本的IP。 那是不是就可以加速访问呢？ 也就是下面的这张图：

![](https://tva1.sinaimg.cn/large/e6c9d24ely1h0gppdksg8j21aa0hw0vu.jpg)

> 延时表示从本地访问各个数据中心的平均延时，仅表示示意，不表示实际情况。

从图中来看，访问日本数据中心是最快的，而访问新加坡是最慢的。 如果本地放弃访问新加坡，而转向访问日本，那速度就会得到一定程度的提高。 

为什么是一定程度呢？  因为这个方案仍然需要过GFW，但走了一条相对而言优质的路由，超时的概率会降低，但并不表示没有。

所以现在我们的方案就变成了，如何找到一条相对优质的路由，并且应用到访问路径。

## 如何找到路由？

从上面找到新加坡的过程可以看出，找到一条优质路由的本质是找到一个访问地点近一些的IP。 而找IP有两种方式：

+ 穷举法。 去github.com官方找到所有的可用IP，包括原站和镜像站。
+ DNS枚举法。 尽可能找到更多的国际DNS服务器，并尝试解析出所有的IP。

第一种穷举法想想都酸爽，这是不可能实现的事情。 一来，我们无法找到所有的IP。 二来，github官方明确告知了IP是动态变化的(参见github开发者使用手册 - 添加github白名单)。所以这条路放弃。

而第二种则是尽可能的找到更多的DNS服务器，定期的向这些DNS服务器请求`github.com`的A记录，这样可以采集到当前实时github.com的可用IP。 但这种方案就依赖于DNS服务器的覆盖范围了。 如果覆盖率不够，那么拿到手的IP就会大打折扣。

但似乎除了这种方式以外，没有其他好的方式了。 

假设目前找到了一组DNS服务器，并且解析出了IP地址。下一步就是找到优质路由了， 简而言之，就是在**本地**不停的发起ICMP请求，看哪个IP的RTT最短。 哪个IP RTT最短，哪个IP相对而言就是优质的。 

为什么是本地呢？ 这是因为，我们是在本地发起的git 操作，只有本地到某个IP延时最短，那么才是最合适本地网络环境的IP。

## 如何让这条路由生效？

再次假设，我们找到了这个IP。 那么我们本地如何在访问github时应用这条路由呢？  这仍然需要从"翻墙"中查找灵感了。 如图所示:

![](https://tva1.sinaimg.cn/large/e6c9d24ely1h0gq49557qj21e60hsq6b.jpg)

本地不再直接访问`github.com`了，而是访问本地的一个代理。这个代理会时刻监测哪个IP是最优的，当有访问`github.com`请求时，这个代理会将请求转发到最优的IP上。而这个操作对git客户端来说是透明的。

## 如何实现代理

这个代理选来选去，选择的是socks5. socks5的优势是:

+ 传输数据快
+ 不受协议类型限制
+ 出错误率低
+ 支持身份认证、TCP和UDP协议

从使用范围上面来看，目前shadowsocks使用的就是socks5协议，几乎非常稳定就说明了其优势。 当然本文中的方案是本地代理，不是远程代理。


那是不是本地搭建一个socks5代理服务器就可以了呢？ 当然不是！ socks5 proxy仅仅是一个桥梁，重点是桥梁的对端是哪里？

所以我们如果想完成这个方案，需要两个模块：

+ IP切换模块 (用于检索本地网络质量最佳的IP)
+ Socks5 Proxy模块 (将访问请求转发到最佳IP)

两个模块的关系如下：

![](https://tva1.sinaimg.cn/large/e6c9d24ely1h0gqh3251jj21ci0ku439.jpg)

IP切换模块需要定期的找到最优IP，然后通知socks5 proxy模块生效。 当用户发起访问时，将请求转发到socks5 proxy模块。 proxy模块再将请求代理到最优IP，直到请求结束。

## 实际效果

目前我完成了这两个模块的功能初步实现，效果还算可以。但还没有开源，这是考虑到还有一些事情没有细化：

1. mac需要封装成app
2. 需要支持动态更新DNS
3. 跨平台编译效果有待观察

为了可以集中精力解决上述三个问题，暂时先不开源。 但未来可期 😊